<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üíñ –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å –ö—É–∫–æ–ª | Kabi MLP</title>
    <link rel="stylesheet" href="dolls.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>

    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <span class="close-btn">&times;</span>
        <img class="lightbox-content" id="lightbox-img">
    </div>

    <header>
        <div class="header-content">
            <h1>–ö–∞–ø—Å—É–ª–∞ –ñ–µ–ª–∞–Ω–∏–π ü´ß</h1>
            <p>–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –∫—É–∫–ª—ã —Å –∫–∞–Ω–∞–ª–∞ <b>@kabi_mlp</b></p>
        </div>
    </header>

    <main>
        <section class="controls-section">
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é..." oninput="applyFilters()">
            </div>

            <div class="actions-row">
                <div class="filter-buttons">
                    <button id="filter-all" class="active" onclick="setCategory('all')">–í—Å–µ</button>
                    <button id="filter-stock" onclick="setCategory('stock')">–í –Ω–∞–ª–∏—á–∏–∏</button>
                    <button id="filter-preorder" onclick="setCategory('preorder')">–ü—Ä–µ–¥–∑–∞–∫–∞–∑</button>
                </div>

                <div class="sort-container">
                    <select id="sort-select" onchange="applyFilters()">
                        <option value="newest">üìÖ –°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                        <option value="price-asc">üí∏ –°–Ω–∞—á–∞–ª–∞ –¥–µ—à–µ–≤—ã–µ</option>
                        <option value="price-desc">üíé –°–Ω–∞—á–∞–ª–∞ –¥–æ—Ä–æ–≥–∏–µ</option>
                    </select>
                </div>
            </div>
        </section>

        <section id="marketplace">
            <div id="dolls-container" class="doll-grid">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞...
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Created with Love ‚ù§Ô∏è</p>
    </footer>

    <script>
        const JSON_URL = '/static/dolls_data.json';
        let allDollsData = [];
        let currentCategory = 'all';

        // === –ó–ê–ì–†–£–ó–ö–ê ===
        async function loadDolls() {
            try {
                const response = await fetch(JSON_URL);
                if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
                allDollsData = await response.json();
                applyFilters(); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
            } catch (error) {
                console.error(error);
                document.getElementById('dolls-container').innerHTML = 
                    '<p class="error-message">üòî –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.</p>';
            }
        }

        // === –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ê–¢–ï–ì–û–†–ò–Ø–ú–ò ===
        function setCategory(category) {
            currentCategory = category;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.filter-buttons button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`filter-${category}`).classList.add('active');
            
            applyFilters();
        }

        // === –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –§–ò–õ–¨–¢–†–ê–¶–ò–ò –ò –°–û–†–¢–ò–†–û–í–ö–ò ===
        function applyFilters() {
            const searchQuery = document.getElementById('search-input').value.toLowerCase();
            const sortValue = document.getElementById('sort-select').value;

            let filtered = allDollsData.filter(doll => {
                // 1. –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                if (currentCategory === 'stock' && doll.is_preorder) return false;
                if (currentCategory === 'preorder' && !doll.is_preorder) return false;

                // 2. –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É
                if (searchQuery) {
                    const text = (doll.text || "").toLowerCase();
                    return text.includes(searchQuery);
                }
                return true;
            });

            // 3. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
            filtered.sort((a, b) => {
                if (sortValue === 'newest') {
                    // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–µ–¥–∑–∞–∫–∞–∑–∞–º, –ø–æ—Ç–æ–º –ø–æ ID
                    if (a.is_preorder !== b.is_preorder) return a.is_preorder ? -1 : 1;
                    return b.id - a.id;
                } 
                else if (sortValue === 'price-asc') {
                    return (parseFloat(a.price) || 999999) - (parseFloat(b.price) || 999999);
                } 
                else if (sortValue === 'price-desc') {
                    return (parseFloat(b.price) || 0) - (parseFloat(a.price) || 0);
                }
            });

            renderDolls(filtered);
        }

        // === –û–¢–†–ò–°–û–í–ö–ê ===
        function renderDolls(data) {
            const container = document.getElementById('dolls-container');
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = '<div class="empty-state">Nothing found ü•∫</div>';
                return;
            }

            data.forEach(doll => {
                const isPreorder = doll.is_preorder;
                const statusText = isPreorder ? '–ü—Ä–µ–¥–∑–∞–∫–∞–∑' : '–í –Ω–∞–ª–∏—á–∏–∏';
                const statusClass = isPreorder ? 'status-preorder' : 'status-stock';
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞
                let cleanText = doll.text.replace(/#\w+/g, '').replace(/\n\s*\n/g, '\n').trim();
                let title = cleanText.split('\n')[0].substring(0, 50);
                let desc = cleanText.split('\n').slice(1).join(' ').substring(0, 100) + '...';

                // –¶–µ–Ω—ã
                let priceHtml = '';
                if (doll.price) {
                    let delHtml = doll.delivery_price ? `<span class="delivery">+${doll.delivery_price} –¥—Å</span>` : '';
                    priceHtml = `<div class="price-row"><span class="price">${doll.price} ‚Ç¥</span>${delHtml}</div>`;
                }

                // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ—Ç–æ
                let multiPhotoHtml = '';
                if (doll.photo_count > 1) {
                    multiPhotoHtml = `<div class="badge-photo"><i class="fas fa-images"></i> ${doll.photo_count}</div>`;
                }

                // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                let commentHtml = '';
                if (doll.comment_count > 0) {
                    commentHtml = `<span class="meta-comment"><i class="far fa-comment"></i> ${doll.comment_count}</span>`;
                }

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-image-wrapper" onclick="openLightbox('${doll.photo_path}')">
                        <span class="status-badge ${statusClass}">${statusText}</span>
                        ${multiPhotoHtml}
                        <img src="${doll.photo_path || '/placeholder.jpg'}" alt="${title}" loading="lazy">
                        <div class="overlay"><i class="fas fa-search-plus"></i></div>
                    </div>
                    <div class="card-content">
                        <div class="card-header">
                            <h3>${title}</h3>
                            ${commentHtml}
                        </div>
                        ${priceHtml}
                        <p class="desc">${desc}</p>
                        <a href="${doll.link}" target="_blank" class="btn-buy">
                            <i class="fab fa-telegram-plane"></i> 
                            ${isPreorder ? '–ó–∞–ø–∏—Å–∞—Ç—å—Å—è' : '–ö—É–ø–∏—Ç—å'}
                        </a>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // === –õ–ê–ô–¢–ë–û–ö–° (–ü–†–û–°–ú–û–¢–† –§–û–¢–û) ===
        function openLightbox(src) {
            if(!src) return;
            const lightbox = document.getElementById('lightbox');
            const img = document.getElementById('lightbox-img');
            img.src = src;
            lightbox.classList.add('active');
            document.body.style.overflow = 'hidden'; // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª —Å–∞–π—Ç–∞
        }

        function closeLightbox() {
            const lightbox = document.getElementById('lightbox');
            lightbox.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        loadDolls();
    </script>
</body>
</html>
