<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ú® Doll Magic Shop | Kabi MLP</title>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;600;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="dolls.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>
    <div class="easter-egg-container">
        <i class="fas fa-skull floating-icon" style="top:10%; left:5%"></i>
        <i class="fas fa-heart-broken floating-icon" style="top:20%; right:10%"></i>
        <i class="fas fa-bolt floating-icon" style="top:50%; left:15%"></i>
    </div>

    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <span class="close-btn">&times;</span>
        <img class="lightbox-content" id="lightbox-img">
    </div>

    <header>
        <div class="header-inner">
            <h1 onclick="triggerEasterEgg()">üîÆ –í–æ–ª—à–µ–±–Ω–∞—è –õ–∞–≤–∫–∞</h1>
            <p>Monster High ‚Ä¢ Ever After High ‚Ä¢ MLP</p>
        </div>
    </header>

    <main>
        <section class="controls-section">
            <div class="search-box">
                <i class="fas fa-magic"></i>
                <input type="text" id="search-input" placeholder="–ù–∞–π—Ç–∏ –∫—É–∫–ª—É –º–µ—á—Ç—ã..." oninput="applyFilters()">
            </div>

            <div class="filters">
                <button id="filter-all" class="active" onclick="setCategory('all')">–í—Å–µ —á—É–¥–µ—Å–∞</button>
                <button id="filter-stock" onclick="setCategory('stock')">–í –Ω–∞–ª–∏—á–∏–∏</button>
                <button id="filter-preorder" onclick="setCategory('preorder')">–ü—Ä–µ–¥–∑–∞–∫–∞–∑</button>
                
                <div class="custom-select">
                    <select id="sort-select" onchange="applyFilters()">
                        <option value="newest">üìÖ –ù–æ–≤–∏–Ω–∫–∏</option>
                        <option value="price-asc">üå∏ –°–Ω–∞—á–∞–ª–∞ –¥–æ—Å—Ç—É–ø–Ω—ã–µ</option>
                        <option value="price-desc">üëë –°–Ω–∞—á–∞–ª–∞ —ç–∫—Å–∫–ª—é–∑–∏–≤</option>
                    </select>
                </div>
            </div>
        </section>

        <section id="marketplace">
            <div id="dolls-container" class="doll-grid">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> –°–æ–±–∏—Ä–∞–µ–º –º–∞–≥–∏—é...
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>Created with üíñ for my love</p>
    </footer>

    <script>
        const JSON_URL = '/static/dolls_data.json';
        let allDollsData = [];
        let currentCategory = 'all';

        async function loadDolls() {
            try {
                const response = await fetch(JSON_URL);
                if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
                allDollsData = await response.json();
                applyFilters();
            } catch (error) {
                console.error(error);
                document.getElementById('dolls-container').innerHTML = 
                    '<p class="error-message">üòî –ú–∞–≥–∏—è —Ä–∞—Å—Å–µ—è–ª–∞—Å—å... –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.</p>';
            }
        }

        function setCategory(category) {
            currentCategory = category;
            document.querySelectorAll('.filters button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`filter-${category}`).classList.add('active');
            applyFilters();
        }

        function applyFilters() {
            const searchQuery = document.getElementById('search-input').value.toLowerCase();
            const sortValue = document.getElementById('sort-select').value;

            let filtered = allDollsData.filter(doll => {
                if (currentCategory === 'stock' && doll.is_preorder) return false;
                if (currentCategory === 'preorder' && !doll.is_preorder) return false;
                if (searchQuery) {
                    const text = (doll.text || "").toLowerCase();
                    return text.includes(searchQuery);
                }
                return true;
            });

            filtered.sort((a, b) => {
                if (sortValue === 'newest') return b.id - a.id;
                else if (sortValue === 'price-asc') return (parseFloat(a.price) || 999999) - (parseFloat(b.price) || 999999);
                else if (sortValue === 'price-desc') return (parseFloat(b.price) || 0) - (parseFloat(a.price) || 0);
            });

            renderDolls(filtered);
        }

        function renderDolls(data) {
            const container = document.getElementById('dolls-container');
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = '<div class="empty-state">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üï∏Ô∏è</div>';
                return;
            }

            data.forEach(doll => {
                const isPreorder = doll.is_preorder;
                
                // –¢–µ–∫—Å—Ç –∏ –°—Ç–∞–Ω
                let rawText = doll.text;
                let conditionText = null;
                const conditionMatch = rawText.match(/^(—Å—Ç–∞–Ω[:\s].*)$/im);
                if (conditionMatch) {
                    conditionText = conditionMatch[1].replace(/—Å—Ç–∞–Ω[:\s]*/i, '').trim();
                }

                let cleanText = rawText.replace(/#\w+/g, '').trim();
                let title = cleanText.split('\n')[0];
                let description = cleanText.substring(title.length).trim();

                // –¶–µ–Ω—ã
                let priceHtml = '';
                if (doll.price) {
                    let delHtml = doll.delivery_price ? `<span class="delivery">+${doll.delivery_price} –¥—Å</span>` : '';
                    priceHtml = `<div class="price-block"><span class="main-price">${doll.price} ‚Ç¥</span>${delHtml}</div>`;
                }

                // –°—Ç–∞–Ω
                let conditionHtml = '';
                if (conditionText) {
                    conditionHtml = `<div class="condition-badge"><i class="fas fa-sparkles"></i> –°—Ç–∞–Ω: ${conditionText}</div>`;
                }

                // --- –ù–û–í–ê–Ø –°–ï–ö–¶–ò–Ø: –ú–ï–¢–ê –î–ê–ù–ù–´–ï (–§–û–¢–û –ò –ö–û–ú–ú–ï–ù–¢–´) ---
                let metaHtml = '<div class="card-meta">';
                // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                if (doll.comment_count !== undefined) {
                    metaHtml += `<span title="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–∞–Ω–∞–ª–µ"><i class="far fa-comment-dots"></i> ${doll.comment_count}</span>`;
                }
                // –§–æ—Ç–æ (–µ—Å–ª–∏ –±–æ–ª—å—à–µ 1)
                if (doll.photo_count && doll.photo_count > 1) {
                    metaHtml += `<span title="–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤ –∞–ª—å–±–æ–º–µ"><i class="far fa-images"></i> ${doll.photo_count}</span>`;
                }
                metaHtml += '</div>';
                // ----------------------------------------------------

                const card = document.createElement('div');
                card.className = `card ${isPreorder ? 'type-preorder' : 'type-stock'}`;
                
                card.innerHTML = `
                    <div class="card-img-box" onclick="openLightbox('${doll.photo_path}')">
                        <span class="status-label">${isPreorder ? '–ü—Ä–µ–¥–∑–∞–∫–∞–∑' : '–í –Ω–∞–ª–∏—á–∏–∏'}</span>
                        <img src="${doll.photo_path || '/placeholder.jpg'}" loading="lazy" alt="Doll">
                        <div class="hover-overlay"><i class="fas fa-eye"></i></div>
                    </div>
                    <div class="card-body">
                        <div class="card-header-row">
                             <h3 class="card-title">${title}</h3>
                        </div>
                        ${metaHtml}
                        ${conditionHtml}
                        ${priceHtml}
                        <div class="card-text">
                            ${description}
                        </div>
                        <a href="${doll.link}" target="_blank" class="buy-btn">
                            –•–æ—á—É –∫—É–ø–∏—Ç—å! <i class="fas fa-heart"></i>
                        </a>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function openLightbox(src) {
            if(!src) return;
            const lb = document.getElementById('lightbox');
            document.getElementById('lightbox-img').src = src;
            lb.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function triggerEasterEgg() {
            document.body.classList.toggle('magic-mode');
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä —Ç–µ–º—ã
            localStorage.setItem('theme', document.body.classList.contains('magic-mode') ? 'magic' : 'light');
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É
        if(localStorage.getItem('theme') === 'magic') {
            document.body.classList.add('magic-mode');
        }

        loadDolls();
    </script>
</body>
</html>
